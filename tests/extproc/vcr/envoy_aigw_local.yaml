# Copyright Envoy AI Gateway Authors
# SPDX-License-Identifier: Apache-2.0
# The full text of the Apache license is available in the LICENSE file at
# the root of the repo.

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 1062
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: auto
          # Add access log for test inspection
          access_log:
          - name: log_used_token
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: /dev/stdout
              log_format:
                json_format:
                  used_token: "%DYNAMIC_METADATA(ai_gateway_llm_ns:used_token)%"
                  some_cel: "%DYNAMIC_METADATA(ai_gateway_llm_ns:some_cel)%"
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains: ["*"]
              retry_policy:
                retry_on: "5xx,gateway-error,reset,rest-before-request,connect-failure,envoy-ratelimited,retriable-4xx,refused-stream,retriable-status-codes,retriable-headers"
                num_retries: 5
                per_try_timeout: "30s"
                retry_back_off:
                  base_interval: "0.1s"
                  max_interval: "1s"
              routes:
              # Model-based routing first
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: us.meta.llama3-2-1b-instruct-v1:0
                  - name: x-model-name
                    string_match:
                      exact: us.anthropic.claude-3-5-sonnet-20240620-v1:0
                route:
                  auto_host_rewrite: true
                  cluster: aws_bedrock
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: gpt-4o-mini
                route:
                  auto_host_rewrite: true
                  cluster: openai
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: text-embedding-3-small
                route:
                  auto_host_rewrite: true
                  cluster: openai
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: gpt-4o-mini-azure
                route:
                  auto_host_rewrite: true
                  cluster: azure_openai
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: text-embedding-3-small-azure
                route:
                  auto_host_rewrite: true
                  cluster: azure_openai
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: gemini-1.5-flash
                route:
                  auto_host_rewrite: true
                  cluster: gemini
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: llama-3.2-3b-preview
                route:
                  auto_host_rewrite: true
                  cluster: groq
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: grok-beta
                route:
                  auto_host_rewrite: true
                  cluster: grok
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: llama3-8b
                route:
                  auto_host_rewrite: true
                  cluster: sambanova
              - match:
                  prefix: "/"
                  headers:
                  - name: x-model-name
                    string_match:
                      exact: meta-llama/Llama-3.2-1B-Instruct
                route:
                  auto_host_rewrite: true
                  cluster: deepinfra
              # Test backend routing
              - match:
                  prefix: "/"
                  headers:
                  - name: x-test-backend
                    string_match:
                      exact: openai
                route:
                  cluster: testupstream-openai
              - match:
                  prefix: "/"
                  headers:
                  - name: x-test-backend
                    string_match:
                      exact: modelname-override
                route:
                  cluster: testupstream-modelname-override
              - match:
                  prefix: "/"
                  headers:
                  - name: x-test-backend
                    string_match:
                      exact: aws-bedrock
                route:
                  cluster: testupstream-aws
              - match:
                  prefix: "/"
                  headers:
                  - name: x-test-backend
                    string_match:
                      exact: azure-openai
                route:
                  cluster: testupstream-azure
              - match:
                  prefix: "/"
                  headers:
                  - name: x-test-backend
                    string_match:
                      exact: gcp-vertexai
                route:
                  cluster: testupstream-gcp-vertexai
              - match:
                  prefix: "/"
                  headers:
                  - name: x-test-backend
                    string_match:
                      exact: gcp-anthropicai
                route:
                  cluster: testupstream-gcp-anthropicai
              # Default routes for specific paths
              - match:
                  path: "/v1/chat/completions"
                route:
                  cluster: openai
              - match:
                  path: "/v1/embeddings"
                route:
                  cluster: openai
              - match:
                  path: "/v1/models"
                route:
                  cluster: openai
              # Catch-all
              - match:
                  prefix: "/"
                direct_response:
                  status: 404
                  body:
                    inline_string: 'not forwarding paths except in cmd/extproc/mainlib/main.go'
                typed_per_filter_config:
                  envoy.filters.http.ext_proc:
                    "@type": type.googleapis.com/envoy.config.route.v3.FilterConfig
                    disabled: true
          http_filters:
          # Simulate real config injected via EnvoyExtensionPolicy
          - name: envoy.filters.http.ext_proc
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
              allow_mode_override: true
              processing_mode:
                request_header_mode: SEND
                response_header_mode: SEND
                request_body_mode: BUFFERED
                response_body_mode: BUFFERED
              grpc_service:
                envoy_grpc:
                  cluster_name: extproc_cluster
              metadataOptions:
                receivingNamespaces:
                  untyped:
                  - ai_gateway_llm_ns
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              suppressEnvoyHeaders: true
  clusters:
  - name: openai
    connect_timeout: 0.25s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: openai
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: host.docker.internal
                port_value: 11434
          # Add metadata in prod set by XDS: xds.upstream_host_metadata
          metadata:
            filter_metadata:
              aigateway.envoy.io:
                per_route_rule_backend_name: "openai"
  - name: extproc_cluster
    connect_timeout: 0.25s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: extproc_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: extproc
                port_value: 1063
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options:
            connection_keepalive:
              interval: 30s
              timeout: 5s
  # Test upstream clusters - all pointing to Ollama for testing
  - name: testupstream-openai
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: testupstream-openai
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 11434
  - name: testupstream-modelname-override
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: testupstream-modelname-override
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 11434
  - name: testupstream-aws
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: testupstream-aws
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 11434
  - name: testupstream-azure
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: testupstream-azure
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 11434
  - name: testupstream-gcp-vertexai
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: testupstream-gcp-vertexai
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 11434
  - name: testupstream-gcp-anthropicai
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: testupstream-gcp-anthropicai
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 11434
  # Production clusters - all pointing to Ollama for testing
  - name: aws_bedrock
    connect_timeout: 30s
    type: STRICT_DNS
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: aws_bedrock
      endpoints:
      - lb_endpoints:
        - endpoint:
            hostname: host.docker.internal
            address:
              socket_address:
                address: host.docker.internal
                port_value: 11434
  - name: azure_openai
    connect_timeout: 30s
    type: STRICT_DNS
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: azure_openai
      endpoints:
      - lb_endpoints:
        - endpoint:
            hostname: host.docker.internal
            address:
              socket_address:
                address: host.docker.internal
                port_value: 11434
  - name: gemini
    connect_timeout: 30s
    type: STRICT_DNS
    dns_lookup_family: V4_ONLY
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: gemini
      endpoints:
      - lb_endpoints:
        - endpoint:
            hostname: host.docker.internal
            address:
              socket_address:
                address: host.docker.internal
                port_value: 11434
  - name: groq
    connect_timeout: 30s
    type: STRICT_DNS
    dns_lookup_family: V4_ONLY
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: groq
      endpoints:
      - lb_endpoints:
        - endpoint:
            hostname: host.docker.internal
            address:
              socket_address:
                address: host.docker.internal
                port_value: 11434
  - name: grok
    connect_timeout: 30s
    type: STRICT_DNS
    dns_lookup_family: V4_ONLY
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: grok
      endpoints:
      - lb_endpoints:
        - endpoint:
            hostname: host.docker.internal
            address:
              socket_address:
                address: host.docker.internal
                port_value: 11434
  - name: sambanova
    connect_timeout: 30s
    type: STRICT_DNS
    dns_lookup_family: V4_ONLY
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: sambanova
      endpoints:
      - lb_endpoints:
        - endpoint:
            hostname: host.docker.internal
            address:
              socket_address:
                address: host.docker.internal
                port_value: 11434
  - name: deepinfra
    connect_timeout: 30s
    type: STRICT_DNS
    dns_lookup_family: V4_ONLY
    outlier_detection:
      consecutive_5xx: 1
      interval: 1s
      base_ejection_time: 2s
      max_ejection_percent: 100
    load_assignment:
      cluster_name: deepinfra
      endpoints:
      - lb_endpoints:
        - endpoint:
            hostname: host.docker.internal
            address:
              socket_address:
                address: host.docker.internal
                port_value: 11434
  - name: original_destination_cluster
    connect_timeout: 30s
    type: ORIGINAL_DST
    lb_policy: CLUSTER_PROVIDED
    original_dst_lb_config:
      http_header_name: x-ai-eg-original-dst
      use_http_header: true

overload_manager:
  refresh_interval: 0.25s
  resource_monitors:
  - name: "envoy.resource_monitors.global_downstream_max_connections"
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.resource_monitors.downstream_connections.v3.DownstreamConnectionsConfig
      max_active_downstream_connections: 1000
